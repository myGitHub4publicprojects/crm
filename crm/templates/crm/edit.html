{% extends "crm/base.html" %}
{% load staticfiles%}

{% block scripts %}
<script src="{% static 'crm/scripts/main.js' %}"></script>
{% endblock scripts %}

{% block content %}
<div class="status mt-2">{% include "crm/status.html" %}</div>

<form action="{% url 'crm:updating' patient.id %}" method="post" id="edit_patient">
{% csrf_token %}
{% include "crm/actions.html" %}
<hr>
<div class="row mt-1">
	<div class="col-lg-9">
		<!-- name, age, tel -->
		<div class="row">
			<div class="col-xl">
			<small class="text-muted">Imię: </small><br>
			<input type="text" name="fname" value="{{ patient.first_name|title }}" class="font-weight-bold" required>
			</div>
			<div class="col-xl">
			<small class="text-muted">Nazwisko: </small><br>
			<input type="text" name="lname" value="{{ patient.last_name|title }}" class="font-weight-bold" required>
			</div>
			<div class="col-xl">
			<small class="text-muted">Data ur: </small><br>
			<input type="date" name="bday" value="{{ patient.date_of_birth|date:'Y-m-d' }}">
			</div>
			<div class="col-xl">
			<small class="text-muted">Nr tel (bez spacji): </small><br>
			<input id="patient_tel" type="tel" pattern="[0-9]{1,}" name="usrtel" value="{{ patient.phone_no }}" required>
			</div>
		</div>


		<!-- address -->
		<div class="row">
			<div class="col-xl">
				<small class="text-muted">Ulica: </small>
				<br>
				<input type="text" name="street"
					{% if patient.street %}
						value="{{ patient.street|title }}"
					{% endif %}
				class="font-weight-bold">
			</div>
			<div class="col-xl">
				<small class="text-muted">Numer budynku/lokalu: </small>
				<br>
				<input type="text" name="house_number"
					{% if patient.house_number %} value="{{ patient.house_number }}" {% endif %}
				class="font-weight-bold w-25">
				/
				<input type="text" name="apartment_number"
					{% if patient.street %} value="{{ patient.apartment_number }}" {% endif %}
				class="font-weight-bold w-25">
			</div>
			<div class="col-xl">
				<small class="text-muted">Miasto: </small>
				<br>
				<input type="text" name="city"
					{% if patient.city %} value="{{ patient.city|title }}" {% endif %}
				class="font-weight-bold">
			</div>
			<div class="col-xl">
				<small class="text-muted">Kod pocztowy: </small>
				<br>
				<input type="text" name="zip_code"
					{% if patient.zip_code %} value="{{ patient.zip_code }}" {% endif %}
				class="font-weight-bold">
			</div>
		</div>
		<hr>

		<!-- patient summary note -->
		<div class="row mt-2">
			<div class="col-xl">
			<textarea form="edit_patient" name="summary_note" id="patient_summary" >{% if patient.notes %}{{ patient.notes }}{% endif %}</textarea>
			</div>
		</div>

		<!-- helper questions -->
		<div class="btn btn-outline-secondary btn-sm" data-toggle="collapse" data-target="#kwest">pytania</div>
		<div class="collapse" id="kwest">
			<div class="card card-body">
			 {% include "crm/kwest.html" %}
			</div>
		</div>

		<hr>

		<!-- location, audometrist, note -->
		<div class="row mt-2">
			<div class="col-xl-3">
				<small class="text-muted">Lokalizacja: </small><br>
				{{ patient.location }}<br>
				<div class="btn btn-secondary" data-toggle="collapse" data-target="#location" aria-expanded="false" aria-controls="location">zmień</div>
				<div class="collapse" id="location">
					<ul class="list-unstyled">
					{% for location in patient.locations %}
						<li>
						<input type="radio" name="location" id="{{ location }}" value="{{ location }}"
							{% if location == patient.location %} checked="checked" {% endif %}
						/>
						<label for="{{ location }}">{{ location }}</label><br/>
						</li>
					{% endfor %}
					</ul>
				</div>
			</div>
			<div class="col-xl-9">
				<textarea form="edit_patient" name="new_note" id="patient_note" placeholder="nowa notatka"></textarea>
			</div>
		
		</div>
		<hr>
		<h4 class="text-center">Aktualnie noszone aparaty:</h4>
		<!-- current hearing aids -->
		<div class="row mt-2">
			{% include "crm/current_hearing_aids.html" %}
		</div>
		<hr>

		<input class="btn btn-primary btn-lg" type="submit" value="Aktualizuj dane pacjenta" />
		</form>
	</div>

	<div class="col-lg-3 mt-2" id="history">
		<small class="text-center">Pacjent dodany przez {{ patient.audiometrist }}, dnia {{ patient.create_date|date:'d-m-Y' }}</small>
		<h3 class="text-center">Historia:</h3>
		<ul class="list-unstyled">
		{% for note in patient_notes %}
			<li>
			<small class="text-center">
				<b>{{ note.timestamp|date:'d-m-Y H:i' }}, wykonał: {{ note.audiometrist }}</b>
				<br>
				{{ note.note }}
			</small>
			<hr>
			</li>
		{% endfor %}
		</ul>
	</div>
</div>

<a class="float-right mb-3" href="{% url 'crm:deleteconfirm' patient.id %}">
	<div class="btn btn-outline-danger">usuń pacjenta</div>
</a>


<div id='invoiceCreate' class="btn btn-outline-warning float-right mb-3">Utwórz nową fakturę</div>


<script>
	var tel_no = document.querySelector('#patient_tel');
	if (tel_no.value == 0) {
		tel_no.className += 'bg-danger';
		alert('Podaj prawidłowy numer telefonu');
	}

	document.addEventListener('click', function (event) {
			if (event.target.classList.contains('finance')) {
				let zip_code = '{{ patient.zip_code }}';
				let city = '{{ patient.city }}';
				let house_number = '{{ patient.house_number }}';
				if (zip_code != 'None' || city != 'None' || house_number == 'None') {
					event.preventDefault();
					alert('Najpierw uzupełnij adres i zaktualizuj dane pacjenta');
				}
			}
		}, false);

</script>

{% endblock content %}